<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Valentine Flute Spark â€” Final Fixed</title>

  <script src="https://unpkg.com/vexflow@4.2.3/build/cjs/vexflow.js"></script>
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>

  <style>
    :root{
      --bg1:#fff5f8; --bg2:#ffe3ee; --card:#ffffffcc;
      --ink:#2a1b22; --muted:#6a4a58; --accent:#ff3b7a;
      --accent2:#ff7aa8; --shadow: 0 18px 50px rgba(30, 10, 20, .12);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 20% 10%, var(--bg2), transparent 60%), linear-gradient(180deg, var(--bg1), #fff);
      overflow-x:hidden;
    }
    .hearts{ position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.55; overflow:hidden; }
    .heart{
      position:absolute; width:16px; height:16px; transform: rotate(45deg);
      background: linear-gradient(180deg, var(--accent2), var(--accent));
      border-radius: 3px; animation: floatUp linear infinite;
    }
    .heart::before, .heart::after{ content:""; position:absolute; width:16px; height:16px; background: inherit; border-radius: 50%; }
    .heart::before{ left:-8px; top:0; } .heart::after{ left:0; top:-8px; }
    @keyframes floatUp{ from{ transform: translateY(120vh) rotate(45deg); opacity:0; } 15%{opacity:1;} to{ transform: translateY(-20vh) rotate(45deg); opacity:0; } }

    .wrap{ position:relative; z-index:1; max-width: 980px; margin: 0 auto; padding: 44px 18px; }
    h1{ margin:0 0 8px 0; font-size: clamp(26px, 4vw, 40px); }
    .card{ background: var(--card); backdrop-filter: blur(10px); border: 1px solid #fff; border-radius: var(--radius); box-shadow: var(--shadow); overflow:hidden; }
    .topbar{ display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:12px; padding: 16px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .controls{ display:flex; gap:10px; }
    
    button{
      border:none; padding: 10px 18px; border-radius: 14px; cursor:pointer; font-weight:650;
      color:white; background: linear-gradient(180deg, var(--accent2), var(--accent));
      box-shadow: 0 10px 20px rgba(255,59,122,0.2);
    }
    button.secondary{ color: var(--ink); background: #fff; border: 1px solid #ddd; box-shadow: none; }
    button:disabled{ opacity:.5; cursor: default; }

    #notation {
      width: 100%; min-height: 280px; overflow-x: auto; padding: 20px;
      background: rgba(255,255,255,0.6); border-radius: 18px; margin: 16px; width: calc(100% - 32px);
    }
  </style>
</head>

<body>
  <div class="hearts" id="hearts"></div>
  <div class="wrap">
    <h1>Valentine Flute Spark ðŸ’˜</h1>
    <div class="card">
      <div class="topbar">
        <div class="controls">
          <button id="btnGen">Generate âœ¨</button>
          <button id="btnPlay" class="secondary">Play â–¶ï¸Ž</button>
          <button id="btnStop" class="secondary" disabled>Stop â– </button>
        </div>
        <div style="font-size: 13px; font-weight: 600;">Eâ™­ Major â€¢ 3 Bars â€¢ Ends on Eb Half-Note</div>
      </div>
      <div id="notation"></div>
    </div>
  </div>

<script>
// --- Hearts ---
(function(){
  const w = document.getElementById("hearts");
  for(let i=0; i<25; i++){
    const h = document.createElement("div"); h.className="heart";
    h.style.left = Math.random()*100+"vw";
    h.style.animationDuration = (8+Math.random()*10)+"s";
    h.style.animationDelay = (-Math.random()*10)+"s";
    w.appendChild(h);
  }
})();

// --- Logic ---
const SCALE = ["eb/4", "f/4", "g/4", "ab/4", "bb/4", "c/5", "d/5", "eb/5", "f/5", "g/5", "ab/5", "bb/5", "c/6"];
const RHYTHMS = [
  { ticks: 4, vf: "q", dur: "4n", beats: 1 },
  { ticks: 2, vf: "8", dur: "8n", beats: 0.5 },
  { ticks: 1, vf: "16", dur: "16n", beats: 0.25 }
];

let currentPhrase = [];
let synth = null;

function generate() {
  const phrase = [];
  let lastNote = "";

  for (let b = 0; b < 3; b++) {
    let rem = 16;
    const measure = [];
    
    // Last bar reserve 8 ticks for the final half note
    const limit = (b === 2) ? 8 : 0;

    while (rem > limit) {
      const possible = RHYTHMS.filter(r => r.ticks <= (rem - limit));
      const r = possible[Math.floor(Math.random() * possible.length)];
      
      let note;
      do {
        note = SCALE[Math.floor(Math.random() * SCALE.length)];
      } while (note === lastNote); // No consecutive repeats

      measure.push({ key: note, vfDur: r.vf, toneDur: r.dur, beats: r.beats });
      rem -= r.ticks;
      lastNote = note;
    }

    if (b === 2) {
      measure.push({ key: "eb/5", vfDur: "h", toneDur: "2n", beats: 2 });
    }
    phrase.push(measure);
  }
  return phrase;
}

function render(phrase) {
  const div = document.getElementById("notation");
  div.innerHTML = "";
  const VF = Vex.Flow;
  
  const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
  renderer.resize(850, 250);
  const context = renderer.getContext();
  
  let x = 20;
  phrase.forEach((measure, i) => {
    const stave = new VF.Stave(x, 50, 260);
    if (i === 0) stave.addClef("treble").addTimeSignature("4/4").addKeySignature("Eb");
    stave.setContext(context).draw();

    const vexNotes = measure.map(n => new VF.StaveNote({ clef: "treble", keys: [n.key], duration: n.vfDur }));
    const beams = VF.Beam.generateBeams(vexNotes);
    
    Vex.Flow.Formatter.FormatAndDraw(context, stave, vexNotes);
    beams.forEach(b => b.setContext(context).draw());
    x += 260;
  });
}

async function handleGen() {
  stopAudio();
  currentPhrase = generate();
  render(currentPhrase);
}

async function playAudio() {
  await Tone.start();
  stopAudio();
  
  synth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" }, envelope: { attack: 0.1 } }).toDestination();
  
  let time = Tone.now() + 0.1;
  currentPhrase.flat().forEach(n => {
    const freq = n.key.replace('/', '');
    synth.triggerAttackRelease(freq, n.toneDur, time);
    time += n.beats * (60 / 156);
  });

  document.getElementById("btnPlay").disabled = true;
  document.getElementById("btnStop").disabled = false;
  
  Tone.Transport.scheduleOnce(() => stopAudio(), time);
}

function stopAudio() {
  if (synth) {
    synth.releaseAll();
    synth.dispose();
    synth = null;
  }
  document.getElementById("btnPlay").disabled = false;
  document.getElementById("btnStop").disabled = true;
}

document.getElementById("btnGen").onclick = handleGen;
document.getElementById("btnPlay").onclick = playAudio;
document.getElementById("btnStop").onclick = stopAudio;

window.onload = handleGen;
</script>
</body>
</html>
