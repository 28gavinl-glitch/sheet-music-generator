<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Valentine Flute Spark â€” Pro Edition</title>

  <script src="https://unpkg.com/vexflow@4.2.3/build/cjs/vexflow.js"></script>
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>

  <style>
    :root {
      --bg1:#fff5f8; --bg2:#ffe3ee; --card:#ffffffcc;
      --ink:#2a1b22; --muted:#6a4a58; --accent:#ff3b7a;
      --accent2:#ff7aa8; --shadow: 0 18px 50px rgba(30, 10, 20, .12);
      --radius: 22px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; min-height: 100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
      color: var(--ink);
      background: radial-gradient(1200px 800px at 20% 10%, var(--bg2), transparent 60%), linear-gradient(180deg, var(--bg1), #fff);
      overflow-x: hidden;
    }
    .hearts { position: fixed; inset: 0; pointer-events: none; z-index: 0; opacity: 0.5; }
    .heart {
      position: absolute; width: 16px; height: 16px; transform: rotate(45deg);
      background: linear-gradient(180deg, var(--accent2), var(--accent));
      border-radius: 3px; animation: floatUp linear infinite;
    }
    .heart::before, .heart::after { content: ""; position: absolute; width: 16px; height: 16px; background: inherit; border-radius: 50%; }
    .heart::before { left: -8px; top: 0; } .heart::after { left: 0; top: -8px; }
    @keyframes floatUp { from { transform: translateY(110vh) rotate(45deg); } to { transform: translateY(-10vh) rotate(45deg); } }

    .wrap { position: relative; z-index: 1; max-width: 900px; margin: 0 auto; padding: 40px 20px; }
    .card { background: var(--card); backdrop-filter: blur(10px); border-radius: var(--radius); border: 1px solid #fff; box-shadow: var(--shadow); overflow: hidden; }
    .topbar { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 12px; padding: 16px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .controls { display: flex; gap: 10px; }
    
    button {
      border: none; padding: 10px 18px; border-radius: 12px; cursor: pointer; font-weight: 600;
      color: white; background: linear-gradient(180deg, var(--accent2), var(--accent));
      transition: transform 0.1s;
    }
    button:active { transform: scale(0.96); }
    button.secondary { color: var(--ink); background: #fff; border: 1px solid #ddd; }
    button:disabled { opacity: 0.4; }

    #notation {
      width: 100%; min-height: 250px; overflow-x: auto; padding: 20px;
      background: rgba(255,255,255,0.6); border-radius: 14px;
      margin: 15px; width: calc(100% - 30px);
      scrollbar-width: thin;
      scrollbar-color: var(--accent) transparent;
    }
    #notation svg { display: block; min-width: 800px; }
  </style>
</head>

<body>
  <div class="hearts" id="hearts"></div>
  <div class="wrap">
    <header>
      <h1 style="margin-bottom:5px;">Valentine Flute Spark ðŸ’˜</h1>
      <p style="color:var(--muted); margin-top:0;">3 Measures â€¢ Ends on Eâ™­ Half Note â€¢ Max Jump: 5th</p>
    </header>

    <div class="card">
      <div class="topbar">
        <div class="controls">
          <button id="btnGen">Generate âœ¨</button>
          <button id="btnPlay" class="secondary">Play â–¶ï¸Ž</button>
          <button id="btnStop" class="secondary" disabled>Stop â– </button>
        </div>
        <div style="font-size:13px; color:var(--muted); font-weight:600;">Eâ™­ Major â€¢ â™©=156</div>
      </div>
      <div id="notation"></div>
    </div>
  </div>

<script>
/* Hearts Logic */
(function(){
  const wrap = document.getElementById("hearts");
  for (let i=0; i<25; i++){
    const h = document.createElement("div"); h.className = "heart";
    h.style.left = Math.random()*100 + "vw";
    h.style.animationDuration = (5 + Math.random()*10) + "s";
    h.style.animationDelay = (-Math.random()*10) + "s";
    h.style.opacity = 0.2 + Math.random()*0.4;
    wrap.appendChild(h);
  }
})();

/* Musical Constraints */
const TEMPO = 156;
const BARS = 3;
const SCALE = ["eb", "f", "g", "ab", "bb", "c", "d"];
const SCALE_MIDI = [63, 65, 67, 68, 70, 72, 74]; // MIDI for Eb4 to D5
const RHYTHMS = [
  { ticks: 1, vf: "16", tone: "16n", beats: 0.25 },
  { ticks: 2, vf: "8",  tone: "8n",  beats: 0.5 },
  { ticks: 4, vf: "q",  tone: "4n",  beats: 1.0 }
];

function generatePhrase() {
  const measures = [];
  let lastMidi = 75; // Starting note Eb5

  for (let m = 0; m < BARS; m++) {
    let remTicks = 16;
    const notes = [];
    
    // Final measure constraint: end on a half note (8 ticks)
    if (m === BARS - 1) remTicks = 8;

    while (remTicks > 0) {
      const possibleRhythms = RHYTHMS.filter(r => r.ticks <= remTicks);
      const r = possibleRhythms[Math.floor(Math.random() * possibleRhythms.length)];
      
      // Select note with constraints:
      // 1. No bigger than a 5th jump (7 semitones)
      // 2. No consecutive repeated notes
      let nextMidi;
      let attempts = 0;
      do {
        const octaveOffset = (Math.floor(Math.random() * 2) + 4) * 12; // Octave 4 or 5
        nextMidi = SCALE_MIDI[Math.floor(Math.random() * SCALE_MIDI.length)] + (Math.random() > 0.5 ? 12 : 0);
        attempts++;
      } while ((nextMidi === lastMidi || Math.abs(nextMidi - lastMidi) > 7) && attempts < 50);

      const noteName = Tone.Frequency(nextMidi, "midi").toNote().toLowerCase().replace('#', 's');
      const vfKey = noteName.replace(/([a-g])(b|s)?(\d)/, "$1$2/$3");

      notes.push({ keys: [vfKey], duration: r.vf, tone: r.tone, beats: r.beats, midi: nextMidi });
      remTicks -= r.ticks;
      lastMidi = nextMidi;
    }

    // Add final half-note E Flat to last bar
    if (m === BARS - 1) {
      notes.push({ keys: ["eb/5"], duration: "h", tone: "2n", beats: 2.0, midi: 75 });
    }
    
    measures.push(notes);
  }
  return measures;
}

function render(phrase) {
  const div = document.getElementById("notation");
  div.innerHTML = "";
  const VF = Vex.Flow;
  
  const width = Math.max(div.clientWidth - 40, 850);
  const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
  renderer.resize(width, 220);
  const context = renderer.getContext();
  const measureWidth = (width - 60) / BARS;

  let x = 30;
  phrase.forEach((measure, i) => {
    const stave = new VF.Stave(x, 40, measureWidth);
    if (i === 0) stave.addClef("treble").addTimeSignature("4/4").addKeySignature("Eb");
    stave.setContext(context).draw();
    
    const vexNotes = measure.map(n => {
      const sn = new VF.StaveNote({ clef: "treble", keys: n.keys, duration: n.duration });
      return sn;
    });

    const beams = VF.Beam.generateBeams(vexNotes);
    Vex.Flow.Formatter.FormatAndDraw(context, stave, vexNotes);
    beams.forEach(b => b.setContext(context).draw());
    x += measureWidth;
  });
}

let currentPhrase = null;
async function generateAndVerify() {
  stopPlayback();
  const div = document.getElementById("notation");
  
  // Logic: Wait for the browser to acknowledge the container's existence
  currentPhrase = generatePhrase();
  
  // Attempt render
  render(currentPhrase);

  // If the render looks empty (BBox check), retry once after a tiny delay
  const svg = div.querySelector('svg');
  if (!svg || svg.getBBox().width < 100) {
    setTimeout(() => render(currentPhrase), 50);
  }
}

/* Audio Engine */
let synth = null;
async function play() {
  await Tone.start();
  if (synth) synth.dispose();
  
  // Flute-like Synth
  synth = new Tone.MonoSynth({
    oscillator: { type: "sine" },
    envelope: { attack: 0.05, release: 0.2 }
  }).toDestination();
  
  const now = Tone.now();
  let timeOffset = 0;
  
  currentPhrase.flat().forEach(n => {
    const freq = Tone.Frequency(n.midi, "midi").toFrequency();
    synth.triggerAttackRelease(freq, n.tone, now + timeOffset);
    timeOffset += n.beats * (60 / TEMPO);
  });

  document.getElementById("btnPlay").disabled = true;
  document.getElementById("btnStop").disabled = false;
  
  Tone.Transport.scheduleOnce(() => {
    stopPlayback();
  }, `+${timeOffset + 0.5}`);
}

function stopPlayback() {
  if (synth) synth.releaseAll();
  document.getElementById("btnPlay").disabled = false;
  document.getElementById("btnStop").disabled = true;
}

document.getElementById("btnGen").onclick = generateAndVerify;
document.getElementById("btnPlay").onclick = play;
document.getElementById("btnStop").onclick = stopPlayback;

window.onload = () => {
  setTimeout(generateAndVerify, 100);
};
</script>
</body>
</html>
