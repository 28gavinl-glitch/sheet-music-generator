<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Valentine Flute Spark ‚Äî Random Eb Major Line</title>

  <!-- VexFlow (notation) -->
  <script src="https://unpkg.com/vexflow@4.2.3/build/cjs/vexflow.js"></script>
  <!-- Tone.js (audio) -->
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>

  <style>
    :root{
      --bg1:#fff5f8; --bg2:#ffe3ee; --card:#ffffffcc;
      --ink:#2a1b22; --muted:#6a4a58;
      --accent:#ff3b7a; --accent2:#ff7aa8;
      --shadow: 0 18px 50px rgba(30,10,20,.12);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 20% 10%, var(--bg2), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, #fff, transparent 55%),
        radial-gradient(1000px 700px at 50% 95%, #ffd3e4, transparent 60%),
        linear-gradient(180deg, var(--bg1), #fff);
      overflow-x:hidden;
    }

    /* ‚ù§Ô∏è Floating hearts */
    .hearts{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .heart{
      position: absolute;
      width: 16px;
      height: 16px;
      transform: rotate(45deg);
      background: linear-gradient(180deg, var(--accent2), var(--accent));
      border-radius: 3px;
      opacity: 0.55;
      animation: floatUp linear infinite;
      filter: drop-shadow(0 6px 8px rgba(255,59,122,.2));
    }
    .heart::before,
    .heart::after{
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      background: inherit;
      border-radius: 50%;
    }
    .heart::before{ left: -8px; top: 0; }
    .heart::after{ left: 0; top: -8px; }

    @keyframes floatUp{
      from{ transform: translateY(120vh) rotate(45deg); opacity:0; }
      15%{ opacity:.6; }
      to{ transform: translateY(-20vh) rotate(45deg); opacity:0; }
    }

    .wrap{
      position:relative; z-index:1;
      max-width:980px;
      margin:0 auto;
      padding:44px 18px 54px;
    }

    h1{
      margin:0 0 8px;
      font-size: clamp(26px, 4vw, 40px);
      letter-spacing:-0.02em;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:15px;
      max-width:72ch;
    }

    .card{
      background: var(--card);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topbar{
      display:flex;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid rgba(0,0,0,.08);
    }

    button{
      border:none;
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:650;
      background: linear-gradient(180deg, var(--accent2), var(--accent));
      color:white;
      box-shadow: 0 10px 22px rgba(255,59,122,.25);
    }
    button.secondary{
      background: linear-gradient(180deg, #fff, #ffe9f2);
      color:var(--ink);
    }
    button:disabled{ opacity:.55; }

    .stage{ padding:16px; }

    #notation{
      width:100%;
      min-height:190px;
      overflow-x:auto;
      padding:10px;
      border-radius:18px;
      background: rgba(255,255,255,.65);
      border:1px solid rgba(0,0,0,.08);
    }

    .footer{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      color:var(--muted);
      font-size:13px;
    }
  </style>
</head>

<body>
<div class="hearts" id="hearts"></div>

<div class="wrap">
  <h1>Valentine Flute Spark üíò</h1>
  <p class="subtitle">
    Random fast flute passage in <b>E‚ô≠ major</b>.  
    <b>3 bars</b>, always fits <b>4/4</b>, leaps ‚â§ <b>perfect fifth</b>.
  </p>

  <div class="card">
    <div class="topbar">
      <button id="btnGen">Generate ‚ú®</button>
      <button id="btnPlay" class="secondary">Play ‚ñ∂Ô∏é</button>
      <button id="btnStop" class="secondary" disabled>Stop ‚ñ†</button>
    </div>

    <div class="stage">
      <div id="notation"></div>
      <div class="footer">
        <span>VexFlow + Tone.js</span>
        <span>If audio doesn‚Äôt start, click Play again</span>
      </div>
    </div>
  </div>
</div>

<script>
/* ‚ù§Ô∏è hearts */
(function(){
  const wrap = document.getElementById("hearts");
  for(let i=0;i<28;i++){
    const h=document.createElement("div");
    h.className="heart";
    const s=10+Math.random()*16;
    h.style.width=h.style.height=s+"px";
    h.style.left=Math.random()*100+"vw";
    h.style.animationDuration=(10+Math.random()*12)+"s";
    h.style.animationDelay=(-Math.random()*10)+"s";
    wrap.appendChild(h);
  }
})();

/* ================= MUSIC ENGINE ================= */
const TEMPO=156, BARS=3;
const SCALE=["eb","f","g","ab","bb","c","d"];
const MAX_LEAP=7;
const BAR_TICKS=16;

const RHY=[
  {t:1,v:"16",d:0,td:"16n"},
  {t:2,v:"8",d:0,td:"8n"},
  {t:3,v:"8",d:1,td:"8n."},
  {t:4,v:"q",d:0,td:"4n"},
  {t:6,v:"q",d:1,td:"4n."},
  {t:8,v:"h",d:0,td:"2n"}
];

function randW(a,w){let s=w.reduce((x,y)=>x+y,0),r=Math.random()*s;
for(let i=0;i<a.length;i++){r-=w[i];if(r<=0)return a[i];}return a[0];}

function nextNote(pi,pm){
  const deltas=[-4,-3,-2,-1,0,1,2,3,4];
  const idx=(pi+deltas[Math.floor(Math.random()*deltas.length)]+7)%7;
  const pc=SCALE[idx];
  const oct=[4,5,6][Math.floor(Math.random()*3)];
  const vk=`${pc}/${oct}`;
  const tn=pc[0].toUpperCase()+"b"+oct;
  const m=Tone.Frequency(tn).toMidi();
  if(pm && Math.abs(m-pm)>MAX_LEAP) return nextNote(pi,pm);
  return {idx,vk,tn,m};
}

function gen(){
  let pi=Math.floor(Math.random()*7);
  let pm=Tone.Frequency("Eb5").toMidi();
  const out=[];
  for(let b=0;b<BARS;b++){
    let r=BAR_TICKS, bar=[];
    while(r>0){
      const tok=randW(RHY,RHY.map(x=>1));
      if(tok.t>r) continue;
      const n=nextNote(pi,pm);
      bar.push({...tok,...n,beats:tok.t/4});
      pi=n.idx; pm=n.m; r-=tok.t;
    }
    out.push(bar);
  }
  return out;
}

/* ================= RENDER ================= */
let phrase=null;
function render(p){
  const d=document.getElementById("notation");
  d.innerHTML="";
  const VF=Vex.Flow;
  const maxN=Math.max(...p.map(b=>b.length));
  const w=Math.max(900, maxN*90);
  const r=new VF.Renderer(d,VF.Renderer.Backends.SVG);
  r.resize(w,230);
  const c=r.getContext();
  const mw=(w-36)/BARS;
  const st=[];
  for(let i=0;i<BARS;i++){
    const s=new VF.Stave(18+i*mw,70,mw);
    if(i===0)s.addClef("treble").addTimeSignature("4/4").addKeySignature("Eb");
    s.setContext(c).draw(); st.push(s);
  }
  p.forEach((bar,i)=>{
    const notes=bar.map(n=>{
      const sn=new VF.StaveNote({keys:[n.vk],duration:n.v});
      if(n.d)sn.addDotToAll(); return sn;
    });
    const v=new VF.Voice({num_beats:4,beat_value:4}).setStrict(true);
    v.addTickables(notes);
    new VF.Formatter().joinVoices([v]).formatToStave([v],st[i]);
    v.draw(c,st[i]);
    VF.Beam.generateBeams(notes).forEach(b=>b.setContext(c).draw());
  });
}

/* ================= AUDIO ================= */
let synth=null, part=null;
async function play(){
  await Tone.start();
  Tone.Transport.stop(); Tone.Transport.cancel();
  Tone.Transport.bpm.value=TEMPO;
  synth=new Tone.Synth({oscillator:{type:"sine"}}).toDestination();
  let t=0;
  part=new Tone.Part((time,v)=>{
    synth.triggerAttackRelease(v.tn,v.td,time);
  }, phrase.flatMap(b=>b.map(n=>[t+=n.beats*60/TEMPO,n])));
  part.start(0);
  Tone.Transport.start();
}

function stop(){
  Tone.Transport.stop(); Tone.Transport.cancel();
}

/* ================= UI ================= */
document.getElementById("btnGen").onclick=()=>{phrase=gen();render(phrase);};
document.getElementById("btnPlay").onclick=play;
document.getElementById("btnStop").onclick=stop;

window.onload=()=>{phrase=gen();render(phrase);};
</script>
</body>
</html>
